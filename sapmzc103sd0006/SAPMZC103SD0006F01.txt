*&---------------------------------------------------------------------*
*& Include          SAPMZC103SD0006F01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*& Form set_init_date
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_init_date .

  " â–¶ ì˜¤ëŠ˜ ê¸°ì¤€ìœ¼ë¡œ í•œ ë‹¬ ì „ ë‚ ì§œ ê³„ì‚° â†’ ì¡°íšŒ ê°€ëŠ¥ ì‹œì‘ì¼(gv_min_date)
  CALL FUNCTION 'RP_CALC_DATE_IN_INTERVAL'
    EXPORTING
      date      = sy-datum        " ê¸°ì¤€ì¼: ì˜¤ëŠ˜
      days      = 0
      months    = 1
      years     = 0
      signum    = '-'             " ê³¼ê±° ë°©í–¥(-)
    IMPORTING
      calc_date = gv_min_date.    " ì¡°íšŒ ê°€ëŠ¥ ì‹œì‘ì¼

  " â–¶ ì˜¤ëŠ˜ ê¸°ì¤€ìœ¼ë¡œ í•œ ë‹¬ í›„ ë‚ ì§œ ê³„ì‚° â†’ ì¡°íšŒ ê°€ëŠ¥ ì¢…ë£Œì¼(gv_max_date)
  CALL FUNCTION 'RP_CALC_DATE_IN_INTERVAL'
    EXPORTING
      date      = sy-datum        " ê¸°ì¤€ì¼: ì˜¤ëŠ˜
      days      = 0
      months    = 1
      years     = 0
      signum    = '+'             " ë¯¸ë˜ ë°©í–¥(+)
    IMPORTING
      calc_date = gv_max_date.    " ì¡°íšŒ ê°€ëŠ¥ ì¢…ë£Œì¼

  " â–¶ ìµœì´ˆ ì¡°íšŒ ì‹œ ê¸°ë³¸ ë²”ìœ„ ì§€ì •
  gv_fr_date = gv_min_date.       " í™”ë©´ ê¸°ë³¸ ì‹œì‘ì¼
  gv_to_date = gv_max_date.       " í™”ë©´ ê¸°ë³¸ ì¢…ë£Œì¼

ENDFORM.

*&---------------------------------------------------------------------*
*& Form create_calendar_object
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_calendar_object.

  DATA lv_focus TYPE cnca_utc_date.

  " 1) From ìë¦¬ì˜ Custom Container ìƒì„±
  CREATE OBJECT go_fr_con
    EXPORTING
      container_name = 'C_PICKER_FR'.

  " 2) ë‹¬ë ¥ ìŠ¤íƒ€ì¼/ì„ íƒ ëª¨ë“œ: navigator + date picker, ë²”ìœ„ ì„ íƒ
  gv_calendar_style = cnca_style_h_navigator.
*  gv_calendar_style  = cnca_style_h_navigator.
  gv_selection_style = cnca_sel_interval.  " <-- cnca_sel_range ëŒ€ì‹  cnca_sel_interval

  " 3) ìº˜ë¦°ë” ê°ì²´ ìƒì„± (ë²”ìœ„ ì§€ì • ëª¨ë“œë¥¼ ì§€ì›)
  lv_focus = gv_fr_date.
  CREATE OBJECT go_fr_cal
    EXPORTING
      parent          = go_fr_con
      view_style      = gv_calendar_style
      selection_style = gv_selection_style
      focus_date      = lv_focus.

ENDFORM.                    " create_calendar_object
*&---------------------------------------------------------------------*
*& Form first_entry_process
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM first_entry_process .
  " â–¶ ìµœì´ˆ ì§„ì… ì—¬ë¶€ í™•ì¸ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
  IF gv_first_entry = abap_true.
    gv_first_entry = abap_false.  " í”Œë˜ê·¸ OFF ì²˜ë¦¬

    " â–¶ ë‚ ì§œ ì¡°ê±´ ì´ˆê¸°í™” (ì¡°íšŒ ë²”ìœ„ ë¦¬ì…‹)
    CLEAR: gv_fr_date, gv_to_date.

    " â–¶ ë°ì´í„° ì¡°íšŒ ë° í™”ë©´ ì¶œë ¥ ìˆ˜í–‰
    PERFORM search_data.
    PERFORM display_100_screen.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form search_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM search_data .

  " â–¶ ì´ì „ ë°ì´í„° ì´ˆê¸°í™”
  CLEAR: gt_schedule, gt_cargo_order, gt_disp_sch.

  DATA: lv_pattern   TYPE string,
        lv_cnt_sched TYPE i,
        lv_cnt_order TYPE i,
        lv_msg       TYPE string,
        lv_subrc     TYPE sy-subrc.

  " âœ… 1) ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
  IF ( gv_fr_date IS INITIAL AND gv_to_date IS NOT INITIAL )
   OR ( gv_fr_date IS NOT INITIAL AND gv_to_date IS INITIAL ).
    MESSAGE 'ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.' TYPE 'I'.
    RETURN.
  ENDIF.

  " âœ… 2) ì¡°ê±´ì— ë”°ë¼ í•­ê³µí¸ ìŠ¤ì¼€ì¤„ ì¡°íšŒ
  IF gv_fr_date IS INITIAL AND gv_to_date IS INITIAL.
    " ì „ì²´ ì¡°íšŒ (ë‚ ì§œ í•„í„° ì—†ìŒ)
    SELECT * FROM zc103sdt0026
      INTO CORRESPONDING FIELDS OF TABLE @gt_schedule.
  ELSEIF gv_fr_date IS NOT INITIAL AND gv_to_date IS NOT INITIAL.
    " ë‚ ì§œ ì¡°ê±´ìœ¼ë¡œ í•„í„°ë§ ì¡°íšŒ
    SELECT * FROM zc103sdt0026
      WHERE departdate BETWEEN @gv_fr_date AND @gv_to_date
      INTO CORRESPONDING FIELDS OF TABLE @gt_schedule.
  ENDIF.

  " âœ… 3) ìŠ¤ì¼€ì¤„ ë°ì´í„° â†’ í™”ë©´ í‘œì‹œìš© êµ¬ì¡° ë³€í™˜
  PERFORM set_data.

  " âœ… 4) ì¡°ê±´ì— ë§ëŠ” í™”ë¬¼ ì£¼ë¬¸ë‚´ì—­ ì¡°íšŒ
  PERFORM main_cont2.

  " âœ… 5) ê±´ìˆ˜ í™•ì¸
  lv_cnt_sched = lines( gt_schedule ).
  lv_cnt_order = lines( gt_cargo_order ).

  " âœ… 6) ì¡°íšŒ ê²°ê³¼ ë©”ì‹œì§€ ì¶œë ¥
  lv_msg = |ìŠ¤ì¼€ì¥´: { lv_cnt_sched }ê±´, í™”ë¬¼ ì£¼ë¬¸ë‚´ì—­: { lv_cnt_order }ê±´ì´ ì¡°íšŒë˜ì—ˆìŠµë‹ˆë‹¤.|.
  MESSAGE lv_msg TYPE 'S'.

ENDFORM.


*&---------------------------------------------------------------------*
*& Form set_calendar_event
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_calendar_event .
  " â–¶ ë‹¬ë ¥ ê°ì²´(go_fr_cal)ì— ë‚ ì§œ ì„ íƒ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.
  SET HANDLER lcl_event_handler=>on_date_selected FOR go_fr_cal.

  " â–¶ ì´ë²¤íŠ¸ ë“±ë¡ êµ¬ì¡°ì— ì´ë²¤íŠ¸ IDì™€ ì‘ìš© ì´ë²¤íŠ¸ ì—¬ë¶€ë¥¼ ì„¤ì •í•˜ì—¬ í…Œì´ë¸”ì— ì¶”ê°€í•©ë‹ˆë‹¤.

  " 1. ë‚ ì§œ ì„ íƒ ì´ë²¤íŠ¸ (ë‹¨ìˆœ ì´ë²¤íŠ¸)
  myevent-appl_event = ' '.  " ì‘ìš© ì´ë²¤íŠ¸ ì•„ë‹˜
  myevent-eventid    = go_fr_cal->m_id_date_selected.
  APPEND myevent TO myevent_tab.

  " 2. ì‚¬ì „ ì„ íƒ ì´ë²¤íŠ¸ (ì‘ìš© ì´ë²¤íŠ¸)
  myevent-appl_event = 'X'.  " ì‘ìš© ì´ë²¤íŠ¸ë¡œ ì„¤ì •
  myevent-eventid    = go_fr_cal->m_id_pre_selection.
  APPEND myevent TO myevent_tab.

  " 3. ë‚ ì§œ ì •ë³´ ìš”ì²­ ì´ë²¤íŠ¸
  myevent-eventid    = go_fr_cal->m_id_info_request.
  APPEND myevent TO myevent_tab.

  " 4. ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìš”ì²­ ì´ë²¤íŠ¸
  myevent-eventid    = go_fr_cal->m_id_ctxmenu_request.
  APPEND myevent TO myevent_tab.

  " 5. ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì„ íƒ ì´ë²¤íŠ¸
  myevent-eventid    = go_fr_cal->m_id_ctxmenu_selected.
  APPEND myevent TO myevent_tab.

  " â–¶ ë‹¬ë ¥ ê°ì²´ì— ìœ„ì—ì„œ êµ¬ì„±í•œ ì´ë²¤íŠ¸ë“¤ì„ ë“±ë¡í•©ë‹ˆë‹¤.
  CALL METHOD go_fr_cal->set_registered_events
    EXPORTING
      events = myevent_tab.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form display_100_screen
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM display_100_screen .
  " â–¶ ALV ì»¨í…Œì´ë„ˆ ë° ê·¸ë¦¬ë“œ ê°ì²´ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì´ˆê¸° ìƒì„± ìˆ˜í–‰
  IF go_container IS NOT BOUND.

    " â–¶ í•­ê³µí¸ ìŠ¤ì¼€ì¤„ ë°ì´í„° ì¡°íšŒ (zc103sdt0026 í…Œì´ë¸” ê¸°ì¤€)
    SELECT scheduleid flightid countryfrom countryto
           departdate departtime arrivedate arrivetime
           flighttime weight_avail weight_unit total_loaded_count
           current_loaded_count_int
      INTO CORRESPONDING FIELDS OF TABLE gt_schedule
      FROM zc103sdt0026
      ORDER BY scheduleid ASCENDING.

    " â–¶ ì¶œë°œ/ë„ì°© êµ­ê°€ ì½”ë“œì— ëŒ€í•œ ë„ë©”ì¸ í…ìŠ¤íŠ¸ ì¡°íšŒ (ê¸°ì´ˆì½”ë“œ)
    SELECT
      FROM dd07v
      FIELDS domvalue_l, ddtext
      WHERE domname = 'ZC103D_FI_LAND'
      INTO CORRESPONDING FIELDS OF TABLE @gt_dd07v.

    " â–¶ ê¸°íƒ€ ë„ë©”ì¸ í…ìŠ¤íŠ¸ (êµ­ê°€, ULDíƒ€ì…, YNì—¬ë¶€ ë“±) ì¡°íšŒ
    SELECT
      FROM dd07v
      FIELDS domvalue_l, ddtext
      WHERE domname = 'ZC103D_FI_LAND'
         OR domname = 'ZC103D_SD_ULDTYPE'
         OR domname = 'ZC103D_SD_YN'
      INTO CORRESPONDING FIELDS OF TABLE @gt_TT07v.

    " â–¶ ì¡°íšŒëœ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í‘œì‹œ êµ¬ì¡° ìƒì„± ë° DB ë™ê¸°í™” ìˆ˜í–‰
    PERFORM set_data.

    " â–¶ ìŠ¤ì¼€ì¤„ì— ì—°ê²°ëœ í™”ë¬¼ ì£¼ë¬¸ ë°ì´í„° ì¡°íšŒ
    PERFORM main_cont2.

    " â–¶ ALV í•„ë“œ ì¹´íƒˆë¡œê·¸ ì¤€ë¹„ (ìŠ¤ì¼€ì¤„ìš©)
    CLEAR: gt_fcat, gs_fcat.
    PERFORM set_field_catalog USING :
      'X' 'SCHEDULEID'           'ZC103SDT0026' 'C' ' ',
      ' ' 'FLIGHTID'                 'ZC103SDT0026' 'C' ' ',
      ' ' 'COUNTRYFROM'         'ZC103SDT0026' 'L' 'X',
      ' ' 'COUNTRYTO'           'ZC103SDT0026' 'L' 'X',
      ' ' 'DEPARTDATE'      'ZC103SDT0026' 'C' ' ',
      ' ' 'DEPARTTIME'      'ZC103SDT0026' 'C' ' ',
      ' ' 'ARRIVEDATE'      'ZC103SDT0026' 'C' ' ',
      ' ' 'ARRIVETIME'      'ZC103SDT0026' 'C' ' ',
      ' ' 'FLIGHTTIME'         'ZC103SDT0026' '' ' ',
      ' ' 'WEIGHT_AVAIL'         'ZC103SDT0026' '' ' ',
      ' ' 'WEIGHT_UNIT'          'ZC103SDT0026' 'C' ' ',
      ' ' 'TOTAL_LOADED_COUNT' 'ZC103SDT0026' 'C' 'X',
      ' ' 'CURRENT_LOADED_COUNT_INT' 'ZC103SDT0026' 'C' ' '.



    CLEAR: gt_fcat3, gs_fcat3.
    PERFORM set_field_catalog02 USING:
    'X' 'TRANSPORTID'     'ZC103SDT0017' 'C' ' ',
    'X' 'BPID'            'ZC103SDT0017' ' ' ' ',
  ' ' 'COUNTRYFROM'         'ZC103SDT0017' 'L' 'X',
  ' ' 'COUNTRYTO'         'ZC103SDT0017' 'L' 'X',
  ' ' 'TDATE'               'ZC103SDT0017' 'C' ' ',
  ' ' 'FLIGHTID'          'ZC103SDT0017' 'C' ' ',
  ' ' 'SCHEDULEID'      'ZC103SDT0017' 'C' ' ',
  ' ' 'WEIGHT'          'ZC103SDT0017' ' ' ' ',
  ' ' 'WEIGHT_UNIT'       'ZC103SDT0017' 'C' ' ',
  ' ' 'ULD_TYPE'       'ZC103SDT0017' ' ' ' ',
  ' ' 'CC_CHECKED'     'ZC103SDT0017' ' ' ' ',
  ' ' 'IS_CONFIRMED'    'ZC103SDT0017' ' ' ' ',
  ' ' 'PRICE'           'ZC103SDT0017' ' ' ' ',
  ' ' 'CURRENCY'         'ZC103SDT0017' ' ' ' ',
  ' ' 'MATID'            'ZC103SDT0017' 'C' 'X',
  ' ' 'BTN_ASSIGN_PALLET' 'ZC103SDT0017' ' ' ' '.
    " â–¶ 2) ë ˆì´ì•„ì›ƒ ë° íˆ´ë°” êµ¬ì„±
    PERFORM set_layout.         " ALV ë ˆì´ì•„ì›ƒ ì„¸íŒ… (zebra, grid title ë“±)
    PERFORM exclude_toolbar.    " ê¸°ë³¸ íˆ´ë°” ê¸°ëŠ¥ ì œì™¸ ì„¤ì •

    " â–¶ 3) ALV ì»¨í…Œì´ë„ˆ ë° ìŠ¤í”Œë¦¬í„° ê°ì²´ ìƒì„±
    CREATE OBJECT go_container
      EXPORTING
        container_name = 'MAIN_CONT'.

    CREATE OBJECT go_split_main
      EXPORTING
        parent  = go_container
        rows    = 2
        columns = 1.

    " â–¶ 4) ë¶„í• ëœ ì»¨í…Œì´ë„ˆ ê°ì²´ ì°¸ì¡° íšë“ (ìœ„ìª½: ìŠ¤ì¼€ì¤„, ì•„ë˜ìª½: í™”ë¬¼ ì£¼ë¬¸)
    CALL METHOD go_split_main->get_container
      EXPORTING
        row       = 1
        column    = 1
      RECEIVING
        container = go_left_cont.

    CALL METHOD go_split_main->get_container
      EXPORTING
        row       = 2
        column    = 1
      RECEIVING
        container = go_right_cont.

    " â–¶ 5) ê° ì»¨í…Œì´ë„ˆì— ALV Grid ìƒì„±
    CREATE OBJECT go_left_grid EXPORTING i_parent = go_left_cont.
    CREATE OBJECT go_right_grid EXPORTING i_parent = go_right_cont.

    " â–¶ 6) ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
    "    - ì˜¤ë¥¸ìª½ ALV ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
    SET HANDLER lcl_event_handler=>handle_btn_click FOR go_right_grid.
    "    - ALV ë”ë¸” í´ë¦­ ì²˜ë¦¬ (ì¢Œ/ìš° ê³µí†µ)
    SET HANDLER lcl_event_handler=>double_click FOR go_left_grid.
    SET HANDLER lcl_event_handler=>double_click FOR go_right_grid.
    "    - ì‚¬ìš©ì ëª…ë ¹ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ì˜ˆ: ë²„íŠ¼ í´ë¦­ ë“±)
    SET HANDLER lcl_event_handler=>user_command FOR go_left_grid.

    " â–¶ 7) ì¢Œì¸¡ ALV (ìŠ¤ì¼€ì¤„ ë¦¬ìŠ¤íŠ¸) ë°ì´í„° ë°”ì¸ë”©
    CALL METHOD go_left_grid->set_table_for_first_display
      EXPORTING
        is_variant           = gs_variant
        i_save               = 'A'
        i_default            = 'X'
        is_layout            = gs_layout1
        it_toolbar_excluding = gt_ui_functions
      CHANGING
        it_outtab            = gt_disp_sch
        it_fieldcatalog      = gt_fcat.

    " â–¶ ìš°ì¸¡ ALV (í™”ë¬¼ ì£¼ë¬¸ ë¦¬ìŠ¤íŠ¸) ë°ì´í„° ë°”ì¸ë”©
    CALL METHOD go_right_grid->set_table_for_first_display
      EXPORTING
        is_variant           = gs_variant
        i_save               = 'A'
        i_default            = 'X'
        is_layout            = gs_layout2
        it_toolbar_excluding = gt_ui_functions
      CHANGING
        it_outtab            = gt_Tisp_ORD
        it_fieldcatalog      = gt_fcat3.

    " â–¶ ì„¸ ë²ˆì§¸ ì˜ì—­ (íŒ”ë ˆíŠ¸ ì˜ì—­ ë“±) ì´ˆê¸° êµ¬ì„±
    PERFORM main_cont3.

  ENDIF.

  " â–¶ (ì„ íƒì ) í•­ìƒ ìµœì‹  ë°ì´í„°ë¥¼ ë°˜ì˜í•˜ê¸° ìœ„í•œ ALV ë¦¬í”„ë ˆì‹œ
*  PERFORM refresh_alv.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form main_cont2
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM main_cont2 .

  " ìŠ¤ì¼€ì¤„ ID ëª©ë¡ì„ ì €ì¥í•  ë‚´ë¶€ í…Œì´ë¸” ë° ë‹¨ì¼ ë³€ìˆ˜ ì„ ì–¸
  DATA: lt_sched_ids TYPE STANDARD TABLE OF zc103e_sd_scheduleid,
        lv_schedid   TYPE zc103e_sd_scheduleid.

  " gt_scheduleì—ì„œ scheduleidë§Œ ì¶”ì¶œí•˜ì—¬ lt_sched_idsì— ì €ì¥
  LOOP AT gt_schedule ASSIGNING FIELD-SYMBOL(<fs_sched>).
    APPEND <fs_sched>-scheduleid TO lt_sched_ids.
  ENDLOOP.

  " ì¤‘ë³µëœ ìŠ¤ì¼€ì¤„ ID ì œê±°ë¥¼ ìœ„í•´ ì •ë ¬ í›„ ì¤‘ë³µ ì œê±° ìˆ˜í–‰
  SORT lt_sched_ids.
  DELETE ADJACENT DUPLICATES FROM lt_sched_ids.

  " ì¶”ì¶œëœ ìŠ¤ì¼€ì¤„ IDì— í•´ë‹¹í•˜ëŠ” í™”ë¬¼ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì—¬ gt_cargo_orderì— ì €ì¥
  SELECT transportid, bpid, matid, countryfrom, countryto, tdate, flightid,
         scheduleid, weight, weight_unit, uld_type, cc_checked,
         is_confirmed, price, currency
    INTO CORRESPONDING FIELDS OF TABLE @gt_cargo_order
    FROM zc103sdt0017
    FOR ALL ENTRIES IN @lt_sched_ids
    WHERE scheduleid = @lt_sched_ids-table_line.

ENDFORM.


*&---------------------------------------------------------------------*
*& Form set_layout
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM set_layout .

  gs_layout1-zebra      = abap_true.
  gs_layout1-cwidth_opt = 'A'.
  gs_layout1-sel_mode   = 'D'.
  gs_layout1-grid_title = 'ì¡°íšŒë˜ëŠ” ìŠ¤ì¼€ì¥´ (í™”ë¬¼ íƒ‘ì¬ëŠ” "â– " ì‹¬ë³¼ë¡œ ì‹œê°í™”ë©ë‹ˆë‹¤)'.

  gs_variant-report    = sy-repid.

  gs_layout2 = CORRESPONDING #( gs_layout1 ).
  gs_layout2-sel_mode = 'A'.  " í–‰ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •!
  gs_layout2-stylefname = 'STYLE'.

  gs_layout2-grid_title = 'í™”ë¬¼ì£¼ë¬¸ë‚´ì—­'.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_field_catalog
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&---------------------------------------------------------------------*
FORM set_field_catalog  USING pv_key pv_field pv_table pv_just pv_emph.

  gs_fcat-key = pv_key.
  gs_fcat-fieldname = pv_field.
  gs_fcat-ref_table = pv_table.
  gs_fcat-just = pv_just.
  gs_fcat-emphasize = pv_emph.


  " 2) ì¶”ê°€ ì†ì„±: í•«ìŠ¤íŒŸ, ì¶œë ¥ì œí•œ, ì»¬ëŸ¼í…ìŠ¤íŠ¸ ë“±
  CASE pv_field.
    WHEN 'SCHEDULEID'.
*      gs_fcat-hotspot = abap_true.
      gs_fcat-coltext = 'ìŠ¤ì¼€ì¥´ ID'.
    WHEN 'FLIGHTID'.
      gs_fcat-coltext = 'í•­ê³µê¸° ID'.
    WHEN 'COUNTRYFROM'.
      gs_fcat-coltext = 'ì¶œë°œ êµ­ê°€'.
    WHEN 'COUNTRYTO'.
      gs_fcat-coltext = 'ë„ì°© êµ­ê°€'.
    WHEN 'DEPARTDATE'.
      gs_fcat-coltext = 'ì¶œë°œ ë‚ ì§œ'.
    WHEN 'DEPARTTIME'.
      gs_fcat-coltext = 'ì¶œë°œ ì‹œê°„'.
    WHEN 'ARRIVEDATE'.
      gs_fcat-coltext = 'ë„ì°© ë‚ ì§œ'.
    WHEN 'ARRIVETIME'.
      gs_fcat-coltext = 'ë„ì°© ì‹œê°„'.
    WHEN 'FLIGHTTIME'.
      gs_fcat-coltext = 'ë¹„í–‰ ì‹œê°„'.
    WHEN 'WEIGHT_AVAIL'.
      gs_fcat-coltext = 'ìˆ˜ìš© ì¤‘ëŸ‰'.
      gs_fcat-Qfieldname = 'WEIGHT_UNIT'.
    WHEN 'WEIGHT_UNIT'.
      gs_fcat-coltext = 'ë¬´ê²Œ ë‹¨ìœ„'.
    WHEN 'TOTAL_LOADED_COUNT'.
      gs_fcat-coltext = 'íƒ‘ì¬ëŸ‰'.
    WHEN 'CURRENT_LOADED_COUNT_INT'.
      gs_fcat-coltext = 'íƒ‘ì¬ì˜ˆì • í™”ë¬¼ìˆ˜'.
      " í•„ìš” ì‹œ ë” ë§ì€ í•„ë“œ ì¶”ê°€ ê°€ëŠ¥
  ENDCASE.


  " 3) í•„ë“œì¹´íƒˆë¡œê·¸ í…Œì´ë¸”ì— ì¶”ê°€
  APPEND gs_fcat TO gt_fcat.

ENDFORM.  " set_field_catalog
*&---------------------------------------------------------------------*
*& Form hotspot_click
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_ROW_ID
*&      --> E_COLUMN_ID
*&---------------------------------------------------------------------*
FORM hotspot_click  USING    p_e_row_id
                             p_e_column_id.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form user_command
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_UCOMM
*&---------------------------------------------------------------------*
FORM user_command USING p_ucomm.

  CASE p_ucomm.
    WHEN '&BTN_BTN_ASSIGN_PALLET'.
      PERFORM assign_pallet_to_order.
  ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_field_catalog02
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&---------------------------------------------------------------------*
FORM set_field_catalog02 USING pv_key pv_field pv_table pv_just pv_emph.

  gs_fcat3-key       = pv_key.
  gs_fcat3-fieldname = pv_field.
  gs_fcat3-ref_table = pv_table.
  gs_fcat3-just      = pv_just.
  gs_fcat3-emphasize = pv_emph.

  CASE pv_field.
    WHEN 'TRANSPORTID'.
      gs_fcat3-coltext = 'í™”ë¬¼ ìš´ì†¡ ì˜ˆì•½ ID'.
    WHEN 'BPID'.
      gs_fcat3-coltext = 'ê±°ë˜ì²˜ ID'.
    WHEN 'MATID'.
      gs_fcat3-coltext = 'ë‹´ë‹¹ íŒ”ë ˆíŠ¸'.
    WHEN 'COUNTRYFROM'.
      gs_fcat3-coltext = 'ì¶œë°œêµ­ê°€'.
    WHEN 'COUNTRYTO'.
      gs_fcat3-coltext = 'ë„ì°©êµ­ê°€'.
    WHEN 'TDATE'.
      gs_fcat3-coltext = 'ìš´ì†¡ì¼ì'.
    WHEN 'FLIGHTID'.
      gs_fcat3-coltext = 'í•­ê³µê¸° ID'.
    WHEN 'SCHEDULEID'.
      gs_fcat3-coltext = 'í•­ê³µí¸ ìŠ¤ì¼€ì¤„ ID'.
    WHEN 'WEIGHT'.
      gs_fcat3-coltext = 'ì´ ì¤‘ëŸ‰(KG)'.
      gs_fcat3-qfieldname = 'WEIGHT_UNIT'.
    WHEN 'WEIGHT_UNIT'.
      gs_fcat3-coltext = 'ì¤‘ëŸ‰ ë‹¨ìœ„'.
    WHEN 'ULD_TYPE'.
      gs_fcat3-coltext = 'ULD íƒ€ì…'.
    WHEN 'CC_CHECKED'.
      gs_fcat3-coltext = 'CC ì ê²€ ì—¬ë¶€'.
    WHEN 'IS_CONFIRMED'.
      gs_fcat3-coltext = 'ì˜ˆì•½ í™•ì • ì—¬ë¶€'.
    WHEN 'PRIORITY'.
      gs_fcat3-coltext = 'ìš°ì„ ìˆœìœ„'.
    WHEN 'PRICE'.
      gs_fcat3-coltext = 'ìš´ì†¡ ê¸ˆì•¡'.
      gs_fcat3-cfieldname = 'CURRENCY'.
    WHEN 'CURRENCY'.
      gs_fcat3-coltext = 'í†µí™”'.
    WHEN 'BTN_ASSIGN_PALLET'.
      gs_fcat3-coltext  = 'íŒ”ë ˆíŠ¸ íƒ‘ì¬'.
      gs_fcat3-style    = cl_gui_alv_grid=>mc_style_button.
      gs_fcat3-edit     = abap_true.
      gs_fcat3-tooltip = 'íŒ”ë ˆíŠ¸ íƒ‘ì¬ ì²˜ë¦¬ ë²„íŠ¼'.

  ENDCASE.



  APPEND gs_fcat3 TO gt_fcat3.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form main_cont3
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM main_cont3 .

  " ì»¨í…Œì´ë„ˆ2 ê°ì²´ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ALV ê´€ë ¨ ì´ˆê¸° êµ¬ì„± ìˆ˜í–‰
  IF go_container2 IS NOT BOUND.

    " íŒ”ë ˆíŠ¸ ë°ì´í„° ì¡°íšŒ ë° ìƒíƒœ ì •ë¦¬ ìˆ˜í–‰
    PERFORM cont3_data.

    " ALV ê·¸ë¦¬ë“œ2ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ëŠ” ë¨¼ì € í™”ë©´ì„ ìƒˆë¡œ ê³ ì¹¨
    IF go_alv_grid2 IS BOUND.
      CALL METHOD go_alv_grid2->refresh_table_display.
    ENDIF.

    " í•„ë“œ ì¹´íƒˆë¡œê·¸ ì´ˆê¸°í™”
    CLEAR : gt_fcat2, gs_fcat2.

    " íŒ”ë ˆíŠ¸ ALVì— í•„ìš”í•œ í•„ë“œ ëª©ë¡ ì„¤ì •
    PERFORM set_field_catalog03 USING :
       ' ' 'ICON_STATUS'   'ZC103SDT0023' 'C' ' ',
       'X' 'PALLET_ID'     'ZC103SDT0023' ' ' ' ',
       ' ' 'PLNID'         'ZC103SDT0023' ' ' 'X',
       ' ' 'STRID'         'ZC103SDT0023' 'C' ' ',
       ' ' 'MATID'         'ZC103SDT0023' 'C' ' ',
       ' ' 'MATNAME'       'ZC103SDT0023' 'C' ' ',
       ' ' 'WEIGHT'        'ZC103SDT0023' 'C' ' ',
       ' ' 'WEIGHT_AVAIL'  'ZC103SDT0023' 'C' ' ',
       ' ' 'WEIGHT_UNIT'   'ZC103SDT0023' 'C' ' '.

    " ë ˆì´ì•„ì›ƒ ì„¤ì • ìˆ˜í–‰
    PERFORM display_layout.

    " ì»¨í…Œì´ë„ˆ ë° ê·¸ë¦¬ë“œ ê°ì²´ ìƒì„±
    PERFORM create_object_3.

    " ALV íˆ´ë°” ë²„íŠ¼ ì œì™¸ ì²˜ë¦¬
    PERFORM EXclUDE_TOOLBAR.

    " íŒ”ë ˆíŠ¸ìš© ALV ê·¸ë¦¬ë“œ ë°ì´í„° ë°”ì¸ë”©
    CALL METHOD go_alv_grid2->set_table_for_first_display
      EXPORTING
        is_variant           = gs_variant2
        i_save               = 'A'
        i_default            = 'X'
        is_layout            = gs_layout02
        it_toolbar_excluding = gt_ui_functions
      CHANGING
        it_outtab            = gt_PALLET
        it_fieldcatalog      = gt_fcat2.

  ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form EXclUDE_TOOLBAR
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM EXclUDE_TOOLBAR .

  DATA: ls_ui_functions TYPE ui_func.

  CLEAR gt_ui_functions.

  " ì „ì²´ íˆ´ë°” ì œê±°ìš© SAP í‘œì¤€ ê¸°ëŠ¥ ì½”ë“œ ì¶”ê°€
  APPEND cl_gui_alv_grid=>mc_fc_loc_copy         TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_loc_cut          TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_loc_delete_row   TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_loc_insert_row   TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_loc_append_row   TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_loc_paste        TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_loc_undo         TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_loc_copy_row     TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_refresh          TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_auf              TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_average          TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_print            TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_graph            TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_find             TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_filter           TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_subtot           TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_sum              TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_sort_asc         TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_sort_dsc         TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_info             TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_views            TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_check            TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_view_crystal     TO gt_ui_functions.
  APPEND cl_gui_alv_grid=>mc_fc_view_excel       TO gt_ui_functions.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form create_object_3
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_object_3 .
  CREATE OBJECT go_container2
    EXPORTING
      container_name = 'MAIN_CONT3'.

  CREATE OBJECT go_alv_grid2
    EXPORTING
      i_parent = go_container2.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form display_layout
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM display_layout .
  gs_layout02-zebra = abap_true.
  gs_layout02-cwidth_opt = 'A'.
  gs_layout02-sel_mode = 'D'.
  gs_layout02-stylefname = 'STYLE'.  " << ì—¬ê¸° ë°˜ë“œì‹œ ì¶”ê°€
  gs_layout02-grid_title = 'ê°€ìš©íŒ”ë ˆíŠ¸ì¡°íšŒ'.
  gs_layout02-stylefname = 'STYLE'.


  gs_variant2-report = sy-repid.
  gs_variant2-handle = 'ALV1'.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form set_field_catalog03
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&      --> P_
*&---------------------------------------------------------------------*
FORM set_field_catalog03 USING    pv_key pv_field pv_table pv_just pv_emph.

  gs_fcat2-key = pv_key.
  gs_fcat2-fieldname = pv_field.
  gs_fcat2-ref_table = pv_table.
  gs_fcat2-just = pv_just.
  gs_fcat2-emphasize = pv_emph.

  CASE pv_field.
    WHEN 'ICON_STATUS'.
      gs_fcat2-coltext = 'ìƒíƒœ í‘œì‹œ'.
      gs_fcat2-icon = abap_true.
    WHEN 'PALLET_ID'.
      gs_fcat2-coltext = 'ì‹œë¦¬ì–¼ ë²ˆí˜¸'.
    WHEN 'PLNID'.
      gs_fcat2-coltext = 'í”ŒëœíŠ¸ ë²ˆí˜¸'.
    WHEN 'STRID'.
      gs_fcat2-coltext = 'S/L ë²ˆí˜¸'.
    WHEN 'MATID'.
      gs_fcat2-coltext = 'íŒ”ë ˆíŠ¸ ë²ˆí˜¸'.
    WHEN 'MATNAME'.
      gs_fcat2-coltext = 'ì´ë¦„'.
    WHEN 'STATUS'.
      gs_fcat2-coltext = 'íŒ”ë ˆíŠ¸ ìƒíƒœ'.
    WHEN 'WEIGHT'.
      gs_fcat2-coltext = 'í˜„ì¬ ë¬´ê²Œ'.
      gs_fcat2-Qfieldname = 'WEIGHT_UNIT'.
    WHEN 'WEIGHT_AVAIL'.
      gs_fcat2-coltext = 'ê°€ìš© ì¤‘ëŸ‰'.
      gs_fcat2-Qfieldname = 'WEIGHT_UNIT'.
    WHEN 'WEIGHT_UNIT'.
      gs_fcat2-coltext = 'ì¤‘ëŸ‰ ë‹¨ìœ„'.
*      gs_fcat2-edit    = abap_true.
  ENDCASE.

  APPEND gs_fcat2 TO gt_fcat2.
ENDFORM.
**********************************************************************
FORM set_data .

  CLEAR: gt_disp_sch, gt_tisp_ord.

  DATA: BEGIN OF gs_sched_count,
          scheduleid TYPE zc103e_sd_scheduleid,
          count      TYPE i,
        END OF gs_sched_count.

  DATA: lt_sched_count LIKE HASHED TABLE OF gs_sched_count WITH UNIQUE KEY scheduleid,
        ls_sched_count LIKE gs_sched_count.

  " 1. ZC103SDT0017 ê¸°ì¤€ SCHEDULEIDë³„ ì ì¬ ìˆ˜ëŸ‰ ì§‘ê³„
  SELECT scheduleid, COUNT(*) AS count
    INTO CORRESPONDING FIELDS OF TABLE @lt_sched_count
    FROM zc103sdt0017
    GROUP BY scheduleid.

  " âœ… 1-1. DB í…Œì´ë¸” ZC103SDT0026ì˜ CURRENT_LOADED_COUNT_INTë„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
  LOOP AT lt_sched_count INTO ls_sched_count.
    UPDATE zc103sdt0026
       SET current_loaded_count_int = @ls_sched_count-count
     WHERE scheduleid = @ls_sched_count-scheduleid.
  ENDLOOP.

  " 2. gt_schedule ë° gt_disp_sch ë°˜ì˜
  LOOP AT gt_schedule ASSIGNING FIELD-SYMBOL(<fs_sched>).
    READ TABLE lt_sched_count INTO ls_sched_count WITH TABLE KEY scheduleid = <fs_sched>-scheduleid.
    <fs_sched>-current_loaded_count_int = COND #( WHEN sy-subrc = 0 THEN ls_sched_count-count ELSE 0 ).

    gs_disp_sch = VALUE #(
      scheduleid               = <fs_sched>-scheduleid
      flightid                 = <fs_sched>-flightid
      countryfrom              = VALUE #( gt_dd07v[ KEY key domvalue_l = <fs_sched>-countryfrom ]-ddtext DEFAULT 'ì•Œìˆ˜ì—†ìŒ' )
      countryto                = VALUE #( gt_dd07v[ KEY key domvalue_l = <fs_sched>-countryto ]-ddtext DEFAULT 'ì•Œìˆ˜ì—†ìŒ' )
      departdate               = <fs_sched>-departdate
      departtime               = <fs_sched>-departtime
      arrivedate               = <fs_sched>-arrivedate
      arrivetime               = <fs_sched>-arrivetime
      flighttime               = <fs_sched>-flighttime
      weight_avail             = <fs_sched>-weight_avail
      weight_unit              = <fs_sched>-weight_unit
      total_loaded_count       = <fs_sched>-total_loaded_count
      current_loaded_count_int = <fs_sched>-current_loaded_count_int ).

    APPEND gs_disp_sch TO gt_disp_sch.
  ENDLOOP.

  " 3. í™”ë¬¼ ì£¼ë¬¸ë‚´ì—­ í™”ë©´ìš© êµ¬ì¡° ë³€í™˜
  LOOP AT gt_cargo_order ASSIGNING FIELD-SYMBOL(<fs_order>).
    gs_tisp_ord = VALUE #(
      transportid        = <fs_order>-transportid
      bpid               = <fs_order>-bpid
      countryfrom        = VALUE #( gt_TT07v[ KEY key domvalue_l = <fs_order>-countryfrom ]-ddtext DEFAULT 'ì•Œìˆ˜ì—†ìŒ' )
      countryto          = VALUE #( gt_TT07v[ KEY key domvalue_l = <fs_order>-countryto ]-ddtext DEFAULT 'ì•Œìˆ˜ì—†ìŒ' )
      tdate              = <fs_order>-tdate
      flightid           = <fs_order>-flightid
      scheduleid         = <fs_order>-scheduleid
      weight             = <fs_order>-weight
      weight_unit        = <fs_order>-weight_unit
      uld_type           = VALUE #( gt_TT07v[ KEY key domvalue_l = <fs_order>-uld_type ]-ddtext DEFAULT 'ì•Œìˆ˜ì—†ìŒ' )
      cc_checked         = VALUE #( gt_TT07v[ KEY key domvalue_l = <fs_order>-cc_checked ]-ddtext DEFAULT 'ì•Œìˆ˜ì—†ìŒ' )
      is_confirmed       = VALUE #( gt_TT07v[ KEY key domvalue_l = <fs_order>-is_confirmed ]-ddtext DEFAULT 'ì•Œìˆ˜ì—†ìŒ' )
      price              = <fs_order>-price
      currency           = <fs_order>-currency
      matid              = <fs_order>-matid
      btn_assign_pallet  = COND #( WHEN <fs_order>-matid IS NOT INITIAL THEN 'ë¬¸ì„œ ì¶œë ¥'
                                   WHEN ( <fs_order>-cc_checked = 'ì ìš©' OR <fs_order>-cc_checked = 'Y' ) AND
                                        ( <fs_order>-is_confirmed = 'ì ìš©' OR <fs_order>-is_confirmed = 'Y' )
                                     THEN 'íŒ”ë ˆíŠ¸ íƒ‘ì¬'
                                   ELSE 'ë¶ˆê°€' ) ).

    APPEND gs_tisp_ord TO gt_tisp_ord.
  ENDLOOP.

ENDFORM.



*&---------------------------------------------------------------------*
*& Form CONT3_DATA
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM cont3_data .

  " â–¶ í˜„ì¬ ë°°ì •ëœ íŒ”ë ˆíŠ¸ IDë“¤ì„ ë‹´ê¸° ìœ„í•œ ë‚´ë¶€ í…Œì´ë¸” ì„ ì–¸
  " - gt_tisp_ord ì— ìˆëŠ” matid(PALLET_ID)ë¥¼ ìˆ˜ì§‘í•¨
  " - í‚¤ ì •ë ¬ë¡œ ë¹ ë¥¸ ê²€ìƒ‰ì„ ìœ„í•´ SORTED KEY ì •ì˜
  DATA: lt_assigned_pallets TYPE TABLE OF zc103e_mm_serial
        WITH NON-UNIQUE SORTED KEY key COMPONENTS table_line.

  " âœ… 1. í™”ë¬¼ ì£¼ë¬¸ ëª©ë¡(gt_tisp_ord)ì—ì„œ ì´ë¯¸ íŒ”ë ˆíŠ¸ê°€ ë°°ì •ëœ í•­ëª©ì„ ì¶”ì¶œ
  LOOP AT gt_tisp_ord ASSIGNING FIELD-SYMBOL(<fs_ord>).
    IF <fs_ord>-matid IS NOT INITIAL.
      " - ì´ë¯¸ ë°°ì •ëœ PALLET_ID ë¥¼ ìˆ˜ì§‘
      APPEND <fs_ord>-matid TO lt_assigned_pallets.
    ENDIF.
  ENDLOOP.

  " âœ… 2. ì „ì²´ ê°€ìš© íŒ”ë ˆíŠ¸ ëª©ë¡ì„ DBì—ì„œ ì¡°íšŒ
  " - ëª¨ë“  íŒ”ë ˆíŠ¸ ì •ë³´ë¥¼ í™”ë©´ìš© ë‚´ë¶€ í…Œì´ë¸” gt_pallet ì— ë‹´ìŒ
  SELECT pallet_id plnid strid matid matname
         status weight weight_avail weight_unit
    INTO CORRESPONDING FIELDS OF TABLE gt_pallet
    FROM zc103sdt0023.

  " âœ… 3. íŒ”ë ˆíŠ¸ ìƒíƒœë³„ ì•„ì´ì½˜ ì§€ì • ë° DB ë™ê¸°í™” ì²˜ë¦¬
  LOOP AT gt_pallet ASSIGNING FIELD-SYMBOL(<fs_pallet>).

    " ğŸš© ì´ë¯¸ ë°°ì •ëœ íŒ”ë ˆíŠ¸ì¸ ê²½ìš° â†’ ë…¸ë€ë¶ˆ ì²˜ë¦¬
    IF line_exists( lt_assigned_pallets[ table_line = <fs_pallet>-pallet_id ] ).
      <fs_pallet>-icon_status = icon_led_yellow.

      " ğŸ”„ ìƒíƒœê°’ì´ Bê°€ ì•„ë‹Œ ê²½ìš°ì—ëŠ” DBì— ìƒíƒœ ì—…ë°ì´íŠ¸ ('B': ë°°ì •ë¨)
      IF <fs_pallet>-status <> 'B'.
        <fs_pallet>-status = 'B'.
        UPDATE zc103sdt0023
           SET status = 'B'
         WHERE pallet_id = @<fs_pallet>-pallet_id.
      ENDIF.

      " ì´ë¯¸ ë°°ì •ëœ ê²½ìš°ëŠ” ì¶”ê°€ íŒë‹¨ ì—†ì´ ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°
      CONTINUE.
    ENDIF.

    " â–¶ ë‚˜ë¨¸ì§€ íŒ”ë ˆíŠ¸ë“¤ì€ ìƒíƒœê°’(status)ì— ë”°ë¼ ì•„ì´ì½˜ ìƒ‰ìƒì„ ë¶€ì—¬
    CASE <fs_pallet>-status.
      WHEN 'A'.  " ì‚¬ìš© ê°€ëŠ¥ â†’ ì´ˆë¡ë¶ˆ
        <fs_pallet>-icon_status = icon_led_green.
      WHEN 'B'.  " ì´ë¯¸ ë°°ì •ë¨ â†’ ë…¸ë€ë¶ˆ (ì´ë¯¸ ì²˜ë¦¬ë¨ì´ì§€ë§Œ ë°©ì–´ ì½”ë“œë¡œ ìœ ì§€)
        <fs_pallet>-icon_status = icon_led_yellow.
      WHEN 'C'.  " ë¹„ì •ìƒ ë˜ëŠ” ê³ ì¥ â†’ ë¹¨ê°„ë¶ˆ
        <fs_pallet>-icon_status = icon_led_red.
      WHEN OTHERS.  " ì •ì˜ë˜ì§€ ì•Šì€ ìƒíƒœ â†’ ì•„ì´ì½˜ ì—†ìŒ
        CLEAR <fs_pallet>-icon_status.
    ENDCASE.

  ENDLOOP.

ENDFORM.



*&---------------------------------------------------------------------*
*& Form refresh_alv
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM refresh_alv .

  " ALV Refresh ì‹œ í–‰(Row)ê³¼ ì—´(Column) ìœ„ì¹˜ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•œ ì„¤ì • êµ¬ì¡°
  DATA(ls_stable) = VALUE lvc_s_stbl( row = abap_true col = abap_true ).

  " ì™¼ìª½ ê·¸ë¦¬ë“œ(ALV) ê°±ì‹ 
  IF go_left_grid IS BOUND.
    CALL METHOD go_left_grid->refresh_table_display
      EXPORTING
        is_stable = ls_stable.
  ENDIF.

  " ì˜¤ë¥¸ìª½ ê·¸ë¦¬ë“œ(ALV) ê°±ì‹ 
  IF go_right_grid IS BOUND.
    CALL METHOD go_right_grid->refresh_table_display
      EXPORTING
        is_stable = ls_stable.
  ENDIF.

**********************************************************************
  " ì•„ë˜ ë¶€ë¶„ì€ ìœ„ì™€ ë™ì¼í•œ ê¸°ëŠ¥ìœ¼ë¡œ ë³´ì´ë©° ì¤‘ë³µ í˜¸ì¶œì…ë‹ˆë‹¤.
  " ë§Œì•½ ì—¬ëŸ¬ ë²ˆ ê°•ì œ ë¦¬í”„ë ˆì‹œê°€ í•„ìš”í•˜ë‹¤ë©´ ìœ ì§€, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì œê±°í•´ë„ ë¬´ë°©í•©ë‹ˆë‹¤.

  ls_stable-row = abap_true.
  ls_stable-col = abap_true.

  " ì™¼ìª½ ê·¸ë¦¬ë“œ ë‹¤ì‹œ í•œ ë²ˆ ê°±ì‹ 
  IF go_left_grid IS BOUND.
    CALL METHOD go_left_grid->refresh_table_display
      EXPORTING
        is_stable = ls_stable.
  ENDIF.

  " íŒ”ë ˆíŠ¸ ALV (go_alv_grid2) ê°±ì‹ 
  IF go_alv_grid2 IS BOUND.
    CALL METHOD go_alv_grid2->refresh_table_display
      EXPORTING
        is_stable = ls_stable.
  ENDIF.

ENDFORM.                    " refresh_alv

*&---------------------------------------------------------------------*
*& Form justdoit
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM justdoit .
  " ë²”ìœ„ ì²´í¬
  IF gv_fr_date < gv_min_date OR gv_to_date > gv_max_date.
    MESSAGE 'í•´ë‹¹ ìš´ì†¡ì€ ì´ë¯¸ ì „ë‹¬ì„ í–ˆê±°ë‚˜, ì•„ì§ ìš´ì†¡ ì¤€ë¹„ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' TYPE 'S'.

    " ğŸ‘‰ ALV í…Œì´ë¸” CLEAR
    CLEAR: gt_schedule, gt_disp_sch, gt_cargo_order.

    " ğŸ‘‰ ALV REFRESH
    PERFORM refresh_alv.
    RETURN.
  ENDIF.

  " ì •ìƒì´ë©´ ë°ì´í„° ë‹¤ì‹œ ì¡°íšŒ
  PERFORM search_data.
  PERFORM set_data.
  PERFORM main_cont2.
  PERFORM refresh_alv.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form double_click
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> E_ROW
*&      --> E_COLUMN
*&---------------------------------------------------------------------*
FORM double_click  USING p_e_row p_e_column.

  DATA: lv_schedid TYPE zc103e_sd_scheduleid,
        ls_ord     LIKE gs_tisp_ord.

  READ TABLE gt_tisp_ord INTO ls_ord INDEX p_e_row.
  IF sy-subrc <> 0.
    RETURN.
  ENDIF.

  lv_schedid = ls_ord-scheduleid.

  " â–¶ gt_disp_sch ë‹¤ì‹œ ë§Œë“¤ì–´ì£¼ê¸° (í•„í„° ê¸°ì¤€ìœ¼ë¡œ!)
  CLEAR gt_disp_sch.

  LOOP AT gt_schedule ASSIGNING FIELD-SYMBOL(<fs_sched>).
    IF <fs_sched>-scheduleid = lv_schedid.

      gs_disp_sch = VALUE #(
        scheduleid               = <fs_sched>-scheduleid
        flightid                 = <fs_sched>-flightid
        countryfrom              = VALUE #( gt_dd07v[ KEY key domvalue_l = <fs_sched>-countryfrom ]-ddtext DEFAULT 'ì•Œìˆ˜ì—†ìŒ' )
        countryto                = VALUE #( gt_dd07v[ KEY key domvalue_l = <fs_sched>-countryto ]-ddtext DEFAULT 'ì•Œìˆ˜ì—†ìŒ' )
        departdate               = <fs_sched>-departdate
        departtime               = <fs_sched>-departtime
        arrivedate               = <fs_sched>-arrivedate
        arrivetime               = <fs_sched>-arrivetime
        flighttime               = <fs_sched>-flighttime
        weight_avail             = <fs_sched>-weight_avail
        weight_unit              = <fs_sched>-weight_unit
        total_loaded_count       = <fs_sched>-total_loaded_count
        current_loaded_count_int = <fs_sched>-current_loaded_count_int
      ).

      APPEND gs_disp_sch TO gt_disp_sch.

    ENDIF.
  ENDLOOP.

  PERFORM refresh_alv.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form assign_pallet_to_order
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM assign_pallet_to_order.

  " ì„ íƒëœ í–‰ ë° ìŠ¤ì¼€ì¤„ ID ë“± ì‘ì—…ìš© ë³€ìˆ˜ ì„ ì–¸
  DATA: lt_row     TYPE lvc_t_row,
        lv_row_idx TYPE lvc_index,
        lv_schedid TYPE zc103e_sd_scheduleid,
        lv_cnt     TYPE i,
        lv_bar     TYPE char10.

  " í•„ë“œ ì‹¬ë³¼ ì„ ì–¸: ì£¼ë¬¸, íŒ”ë ˆíŠ¸, ë² ì´ìŠ¤(ì›ë³¸)
  FIELD-SYMBOLS: <fs_ord>  LIKE LINE OF gt_tisp_ord,
                 <fs_pal>  LIKE LINE OF gt_pallet,
                 <fs_base> LIKE LINE OF gt_cargo_order.

  " 1. ì‚¬ìš©ì ì„ íƒ í–‰ì˜ ì¸ë±ìŠ¤ ê°€ì ¸ì˜¤ê¸°
  CALL METHOD go_right_grid->get_selected_rows
    IMPORTING
      et_index_rows = lt_row.

  READ TABLE lt_row INTO lv_row_idx INDEX 1.
  IF sy-subrc <> 0.
    MESSAGE 'ì„ íƒëœ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.' TYPE 'S'.
    RETURN.
  ENDIF.

  " 2. ì„ íƒëœ ì¸ë±ìŠ¤ë¡œë¶€í„° ì£¼ë¬¸ ë‚´ì—­ ê°€ì ¸ì˜¤ê¸°
  READ TABLE gt_tisp_ord ASSIGNING <fs_ord> INDEX lv_row_idx.
  IF sy-subrc <> 0 OR <fs_ord> IS INITIAL.
    MESSAGE 'ì„ íƒëœ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.' TYPE 'S'.
    RETURN.
  ENDIF.

  " 3. ì¡°ê±´ ì²´í¬: CC ì ê²€ê³¼ ì˜ˆì•½ í™•ì •ì´ "ì ìš©" ë˜ëŠ” "Y"ì—¬ì•¼ í•¨
  IF ( <fs_ord>-cc_checked = 'ì ìš©' OR <fs_ord>-cc_checked = 'Y' ) AND
     ( <fs_ord>-is_confirmed = 'ì ìš©' OR <fs_ord>-is_confirmed = 'Y' ).

    " 4. ì‚¬ìš© ê°€ëŠ¥í•œ íŒ”ë ˆíŠ¸ ê²€ìƒ‰
    LOOP AT gt_pallet ASSIGNING <fs_pal>.
      IF <fs_pal>-status = 'A' AND <fs_pal>-icon_status = icon_led_green.

        " íŒ”ë ˆíŠ¸ IDë¥¼ ì£¼ë¬¸ ê±´ì— í• ë‹¹
        <fs_ord>-matid = <fs_pal>-pallet_id.
        <fs_pal>-icon_status = icon_led_yellow.
        <fs_ord>-btn_assign_pallet = 'ë¬¸ì„œ ì¶œë ¥'.

        " ê´€ë ¨ ì›ë³¸ ë°ì´í„°ë„ ë™ê¸°í™”
        READ TABLE gt_cargo_order ASSIGNING <fs_base>
          WITH KEY transportid = <fs_ord>-transportid.
        IF sy-subrc = 0.
          <fs_base>-matid = <fs_pal>-pallet_id.

          " DBì— íŒ”ë ˆíŠ¸ ID ì§ì ‘ ë°˜ì˜
          UPDATE zc103sdt0017
             SET matid = @<fs_pal>-pallet_id
           WHERE transportid = @<fs_ord>-transportid.
        ENDIF.

        " í˜„ì¬ ì‘ì—… ì¤‘ì¸ ìŠ¤ì¼€ì¤„ ID ì €ì¥
        lv_schedid = <fs_ord>-scheduleid.

        " í•´ë‹¹ ìŠ¤ì¼€ì¤„ì— ëŒ€í•œ ì ì¬ ìˆ˜ëŸ‰ ê³„ì‚°
        SELECT COUNT(*) INTO @lv_cnt
          FROM zc103sdt0017
         WHERE scheduleid = @lv_schedid
           AND matid IS NOT NULL.

        " ì‹œê°ì  ë°”(bar) í‘œì‹œ ë¬¸ìì—´ ìƒì„± (ì˜ˆ: â– â– â– â– ______ )
        CLEAR lv_bar.
        DO lv_cnt TIMES.
          lv_bar = lv_bar && 'â– '.
        ENDDO.
        DO ( 10 - lv_cnt ) TIMES.
          lv_bar = lv_bar && '_'.
        ENDDO.

        " ìŠ¤ì¼€ì¤„ í…Œì´ë¸”ì— ì ì¬ ìˆ˜ëŸ‰ ë° bar ë°˜ì˜
        UPDATE zc103sdt0026
           SET current_loaded_count_int = @lv_cnt,
               total_loaded_count       = @lv_bar
         WHERE scheduleid = @lv_schedid.

        MESSAGE |íŒ”ë ˆíŠ¸ { <fs_pal>-pallet_id }ê°€ ë°°ì • ë° ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.| TYPE 'S'.
        EXIT. " ì²« ë²ˆì§¸ ê°€ëŠ¥í•œ íŒ”ë ˆíŠ¸ë§Œ ì²˜ë¦¬í•˜ê³  ë£¨í”„ ì¢…ë£Œ
      ENDIF.
    ENDLOOP.

    " í• ë‹¹ ê°€ëŠ¥í•œ íŒ”ë ˆíŠ¸ê°€ ì—†ì—ˆì„ ê²½ìš°
    IF <fs_ord>-matid IS INITIAL.
      MESSAGE 'ì‚¬ìš© ê°€ëŠ¥í•œ íŒ”ë ˆíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.' TYPE 'E'.
    ENDIF.

  ELSE.
    " ì ê²€ ë˜ëŠ” ì˜ˆì•½ ìƒíƒœ ë¯¸ì¶©ì¡± ì‹œ ì•ˆë‚´ ë©”ì‹œì§€
    MESSAGE 'CC ì ê²€ ë° ì˜ˆì•½ í™•ì •ì´ "ì ìš©" ë˜ëŠ” "Y"ì´ì–´ì•¼ í•©ë‹ˆë‹¤.' TYPE 'S'.
  ENDIF.

  " ALV ë°ì´í„° ì¬ì •ë¦¬ ë° í™”ë©´ ìƒˆë¡œ ê³ ì¹¨
  PERFORM set_data.
  PERFORM refresh_alv.

ENDFORM.



*&---------------------------------------------------------------------*
*& Form handle_btn_click
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> ES_ROW_NO
*&      --> SENDER
*&---------------------------------------------------------------------*
FORM handle_btn_click USING p_es_row_no TYPE lvc_s_roid
                            p_sender     TYPE REF TO cl_gui_alv_grid.

  " ì„ íƒëœ í–‰ì˜ ì¸ë±ìŠ¤ë¥¼ ë‹´ì„ ë³€ìˆ˜
  DATA: lv_idx TYPE lvc_index.

  " TISP ì£¼ë¬¸ ë‚´ë¶€ í…Œì´ë¸”ì— ëŒ€í•œ í•„ë“œ ì‹¬ë³¼ ì„ ì–¸
  FIELD-SYMBOLS: <fs_ord> LIKE LINE OF gt_tisp_ord.

  " ì „ë‹¬ë°›ì€ ALV í–‰ ë²ˆí˜¸ë¥¼ ì¸ë±ìŠ¤ë¡œ ë³€í™˜
  lv_idx = p_es_row_no-row_id.

  " í•´ë‹¹ ì¸ë±ìŠ¤ì— í•´ë‹¹í•˜ëŠ” ì£¼ë¬¸ ë‚´ì—­ì„ ë‚´ë¶€ í…Œì´ë¸”ì—ì„œ ì¡°íšŒ
  READ TABLE gt_tisp_ord ASSIGNING <fs_ord> INDEX lv_idx.
  IF sy-subrc <> 0 OR <fs_ord> IS INITIAL.
    MESSAGE 'ì„ íƒëœ í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' TYPE 'S'.
    RETURN.
  ENDIF.

  " ë²„íŠ¼ ìƒíƒœì— ë”°ë¼ ê¸°ëŠ¥ ë¶„ê¸° ì²˜ë¦¬
  CASE <fs_ord>-btn_assign_pallet.

    " ì‚¬ìš©ìê°€ 'íŒ”ë ˆíŠ¸ íƒ‘ì¬' ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš°
    WHEN 'íŒ”ë ˆíŠ¸ íƒ‘ì¬'.
      " í•´ë‹¹ ì¸ë±ìŠ¤ ê¸°ì¤€ìœ¼ë¡œ íŒ”ë ˆíŠ¸ ìë™ ë°°ì •
      PERFORM assign_pallet_to_order_index USING lv_idx.
      " íƒ‘ì¬ ì´ë ¥ ë¡œê¹… ì²˜ë¦¬
      PERFORM update_log_id USING <fs_ord>-transportid.

    " ì‚¬ìš©ìê°€ 'ë¬¸ì„œ ì¶œë ¥' ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš°
    WHEN 'ë¬¸ì„œ ì¶œë ¥'.
      " í™”ë¬¼ ê´€ë ¨ ì†¡ì¥ ì¶œë ¥ ì‹¤í–‰
      PERFORM submit_full_save USING <fs_ord>-transportid.

    " íƒ‘ì¬ ë¶ˆê°€ ìƒíƒœì¸ ê²½ìš°
    WHEN 'ë¶ˆê°€'.
      MESSAGE 'ì•„ì§ íƒ‘ì¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' TYPE 'S'.

    " ì •ì˜ë˜ì§€ ì•Šì€ ë²„íŠ¼ ìƒíƒœì¼ ê²½ìš°
    WHEN OTHERS.
      MESSAGE 'ì •ì˜ë˜ì§€ ì•Šì€ ìƒíƒœì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.' TYPE 'E'.

  ENDCASE.

ENDFORM.


*&---------------------------------------------------------------------*
*& Form assign_pallet_to_order_index
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> LV_IDX
*&---------------------------------------------------------------------*
FORM assign_pallet_to_order_index USING p_idx TYPE lvc_index.

  " í•„ë“œ ì‹¬ë³¼ ì„ ì–¸
  FIELD-SYMBOLS: <fs_ord>   LIKE LINE OF gt_tisp_ord,
                 <fs_pal>   LIKE LINE OF gt_pallet,
                 <fs_base>  LIKE LINE OF gt_cargo_order,
                 <fs_sched> LIKE LINE OF gt_schedule.

  " ì‘ì—…ìš© ë³€ìˆ˜ ì„ ì–¸
  DATA: lv_schedid TYPE zc103e_sd_scheduleid,
        lv_cnt     TYPE i,
        lv_bar     TYPE char10.

  " ì„ íƒëœ ì£¼ë¬¸ í–‰ì„ ë‚´ë¶€ í…Œì´ë¸”ì—ì„œ ì¡°íšŒ
  READ TABLE gt_tisp_ord ASSIGNING <fs_ord> INDEX p_idx.
  IF sy-subrc <> 0 OR <fs_ord> IS NOT ASSIGNED.
    RETURN.
  ENDIF.

  " CC ì ê²€ê³¼ ì˜ˆì•½ í™•ì • ìƒíƒœ í™•ì¸
  IF ( <fs_ord>-cc_checked = 'ì ìš©' OR <fs_ord>-cc_checked = 'Y' ) AND
     ( <fs_ord>-is_confirmed = 'ì ìš©' OR <fs_ord>-is_confirmed = 'Y' ).

    " ì‚¬ìš© ê°€ëŠ¥í•œ íŒ”ë ˆíŠ¸ë¥¼ ê²€ìƒ‰í•˜ì—¬ ì²« ë²ˆì§¸ ê±´ì„ í• ë‹¹
    LOOP AT gt_pallet ASSIGNING <fs_pal>
      WHERE status = 'A'
        AND icon_status = icon_led_green.

      " ì£¼ë¬¸ ê±´ê³¼ íŒ”ë ˆíŠ¸ ê°„ ë™ê¸°í™”
      <fs_ord>-matid = <fs_pal>-pallet_id.
      <fs_ord>-btn_assign_pallet = 'ë¬¸ì„œ ì¶œë ¥'.
      <fs_pal>-icon_status = icon_led_yellow.

      " ì›ë³¸ ë°ì´í„°ì—ë„ í• ë‹¹ëœ íŒ”ë ˆíŠ¸ ë°˜ì˜
      READ TABLE gt_cargo_order ASSIGNING <fs_base>
        WITH KEY transportid = <fs_ord>-transportid.
      IF sy-subrc = 0.
        <fs_base>-matid = <fs_pal>-pallet_id.

        " DBì— í™”ë¬¼ ì£¼ë¬¸ ì—…ë°ì´íŠ¸
        UPDATE zc103sdt0017
           SET matid = @<fs_pal>-pallet_id
         WHERE transportid = @<fs_ord>-transportid.

        " DBì— íŒ”ë ˆíŠ¸ ìƒíƒœ 'B'ë¡œ ë³€ê²½
        UPDATE zc103sdt0023
           SET status = 'B'
         WHERE pallet_id = @<fs_pal>-pallet_id.
      ENDIF.

      " ì‚¬ìš©ìì—ê²Œ ë°°ì • ì™„ë£Œ ë©”ì‹œì§€ ì¶œë ¥
      MESSAGE |íŒ”ë ˆíŠ¸ { <fs_pal>-pallet_id }ê°€ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.| TYPE 'S'.
      EXIT.
    ENDLOOP.

    " í• ë‹¹ ì‹¤íŒ¨ ì‹œ ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶œë ¥
    IF <fs_ord>-matid IS INITIAL.
      MESSAGE 'ì‚¬ìš© ê°€ëŠ¥í•œ íŒ”ë ˆíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.' TYPE 'E'.
    ENDIF.

    " ì ì¬ í˜„í™© ê³„ì‚° ë° ë„¤ëª¨ bar ìƒì„±
    lv_schedid = <fs_ord>-scheduleid.

    SELECT COUNT(*) INTO @lv_cnt
      FROM zc103sdt0017
     WHERE scheduleid = @lv_schedid
       AND matid IS NOT NULL.

    CLEAR lv_bar.
    DO 10 TIMES.
      lv_bar = lv_bar && COND string( WHEN sy-index <= lv_cnt THEN 'â– ' ELSE '_' ).
    ENDDO.

    " ìŠ¤ì¼€ì¤„ í…Œì´ë¸”ì— ì ì¬ í˜„í™© ì—…ë°ì´íŠ¸
    UPDATE zc103sdt0026
       SET total_loaded_count        = @lv_bar,
           current_loaded_count_int = @lv_cnt
     WHERE scheduleid = @lv_schedid.

  ELSE.
    " ì ê²€ ë˜ëŠ” ì˜ˆì•½ í™•ì • ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•ŠëŠ” ê²½ìš°
    MESSAGE 'CC ì ê²€ ë° ì˜ˆì•½ í™•ì •ì´ "ì ìš©" ë˜ëŠ” "Y"ì´ì–´ì•¼ í•©ë‹ˆë‹¤.' TYPE 'S'.
  ENDIF.

  " ALV ì¶œë ¥ì„ ìœ„í•œ í‘œì‹œìš© í…Œì´ë¸” ì¬êµ¬ì„±
  CLEAR gt_disp_sch.

  LOOP AT gt_schedule ASSIGNING <fs_sched>
    WHERE scheduleid = <fs_ord>-scheduleid.

    gs_disp_sch = VALUE #(
      scheduleid               = <fs_sched>-scheduleid
      flightid                 = <fs_sched>-flightid
      countryfrom              = VALUE #( gt_dd07v[ KEY key domvalue_l = <fs_sched>-countryfrom ]-ddtext DEFAULT 'ì•Œìˆ˜ì—†ìŒ' )
      countryto                = VALUE #( gt_dd07v[ KEY key domvalue_l = <fs_sched>-countryto ]-ddtext DEFAULT 'ì•Œìˆ˜ì—†ìŒ' )
      departdate               = <fs_sched>-departdate
      departtime               = <fs_sched>-departtime
      arrivedate               = <fs_sched>-arrivedate
      arrivetime               = <fs_sched>-arrivetime
      flighttime               = <fs_sched>-flighttime
      weight_avail             = <fs_sched>-weight_avail
      weight_unit              = <fs_sched>-weight_unit
      total_loaded_count       = lv_bar
      current_loaded_count_int = lv_cnt ).

    APPEND gs_disp_sch TO gt_disp_sch.
  ENDLOOP.

  " ALV ê·¸ë¦¬ë“œ í™”ë©´ ê°±ì‹ 
  PERFORM refresh_alv.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form update_log_id
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> <FS_ORD>_TRANSPORTID
*&---------------------------------------------------------------------*
FORM update_log_id USING p_transportid TYPE zc103e_sd_transportid.

  " ì‘ì—…ìš© ë³€ìˆ˜ ì„ ì–¸
  DATA: lv_last_log TYPE zc103e_sd_logid,
        lv_num_part TYPE n LENGTH 7,
        lv_new_log  TYPE zc103e_sd_logid,
        ls_log      TYPE zc103sdt0024,
        ls_ord      LIKE LINE OF gt_tisp_ord. " ì£¼ë¬¸ ì •ë³´ ì°¸ì¡°

  " ì…ë ¥ëœ ìš´ì†¡ IDì— í•´ë‹¹í•˜ëŠ” ì£¼ë¬¸ ë°ì´í„° ì¡°íšŒ
  READ TABLE gt_tisp_ord INTO ls_ord WITH KEY transportid = p_transportid.
  IF sy-subrc <> 0.
    RETURN. " í•´ë‹¹ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
  ENDIF.

  " í˜„ì¬ ë¡œê·¸ í…Œì´ë¸”ì—ì„œ ê°€ì¥ í° log_id ì¡°íšŒ
  SELECT MAX( log_id ) INTO @lv_last_log FROM zc103sdt0024.

  " ìµœì´ˆ ë¡œê·¸ì¼ ê²½ìš° 1ë¶€í„° ì‹œì‘, ì•„ë‹ˆë©´ ìˆ«ì ì¶”ì¶œ í›„ +1 ì¦ê°€
  IF lv_last_log IS INITIAL.
    lv_num_part = 1.
  ELSE.
    lv_num_part = lv_last_log+3(7). " LOG ì ‘ë‘ì–´ ì œì™¸í•˜ê³  ìˆ«ìë§Œ ì¶”ì¶œ
    lv_num_part = lv_num_part + 1.
  ENDIF.

  " ìƒˆ ë¡œê·¸ ID ìƒì„±: LOG0000001 í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…
  lv_new_log = |LOG{ lv_num_part WIDTH = 7 PAD = '0' }|.

  " ë¡œê·¸ í…Œì´ë¸”ì— ê¸°ë¡í•  í•­ëª© êµ¬ì„±
  ls_log-log_id             = lv_new_log.
  ls_log-cargo_id           = p_transportid.
  ls_log-pallet_no          = ls_ord-matid.
  ls_log-scheduleid         = ls_ord-scheduleid.
  ls_log-bpid               = ls_ord-bpid.
  ls_log-pallet_load_weight = ls_ord-weight.
  ls_log-load_date          = ls_ord-tdate.
  ls_log-erdat              = sy-datum.   " ìƒì„±ì¼ì
  ls_log-erzet              = sy-uzeit.   " ìƒì„±ì‹œê°„
  ls_log-ernam              = sy-uname.   " ìƒì„±ì

  " ìµœì¢… ë¡œê·¸ í…Œì´ë¸”ì— INSERT
  INSERT zc103sdt0024 FROM @ls_log.

ENDFORM.